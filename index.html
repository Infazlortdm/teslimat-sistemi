<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teslimat Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
header{padding:15px;background:#111827;font-size:20px;text-align:center}
input,select,button{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:none}
button{background:#22c55e;color:white;font-weight:bold}
.card{background:#1e293b;padding:15px;margin:10px;border-radius:10px}
.hidden{display:none}
.menu{position:fixed;bottom:0;width:100%;display:flex;background:#111827}
.menu button{flex:1;background:#334155}
img{max-width:100%;border-radius:10px;margin-top:10px}
.badge{background:red;padding:3px 8px;border-radius:10px;font-size:12px}
</style>
</head>

<body>

<header>Teslimat Sistemi</header>

<div id="authBox">
<h3>GiriÅŸ / KayÄ±t</h3>
<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Åifre">
<select id="role">
<option value="isletme">Ä°ÅŸletme</option>
<option value="kurye">Kurye</option>
<option value="admin">Admin</option>
</select>
<input id="region" placeholder="BÃ¶lge (Ã¶rnek: Balkan)">
<button onclick="register()">KayÄ±t Ol</button>
<button onclick="login()">GiriÅŸ Yap</button>
</div>

<div id="app" class="hidden">

<div id="isletmePage" class="hidden">
<h3>Yeni SipariÅŸ</h3>
<input id="note" placeholder="SipariÅŸ Notu">
<input type="file" id="photo" accept="image/*" capture="environment">
<button onclick="createOrder()">SipariÅŸ OluÅŸtur</button>
<div id="isletmeOrders"></div>
</div>

<div id="kuryePage" class="hidden">
<h3>Paketlerim <span id="kuryeCount" class="badge"></span></h3>
<div id="kuryeOrders"></div>
</div>

<div id="adminPage" class="hidden">
<h3>TÃ¼m SipariÅŸler</h3>
<div id="adminOrders"></div>
</div>

<div id="fisPage" class="hidden">
<h3>FiÅŸ DetayÄ±</h3>
<div id="fisContent"></div>
<button onclick="back()">Geri</button>
</div>

<div class="menu">
<button onclick="showPage('isletmePage')">ğŸª</button>
<button onclick="showPage('kuryePage')">ğŸšš</button>
<button onclick="showPage('adminPage')">âš™</button>
<button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjNRgjDF2r6xrtZw9OwOZS6JHsSQt1bvg",
  authDomain: "teslimat-sistemi.firebaseapp.com",
  projectId: "teslimat-sistemi"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData=null;

window.register=async()=>{
const mail=email.value;
const pass=password.value;
const roleVal=role.value;
const regionVal=region.value;

const cred=await createUserWithEmailAndPassword(auth,mail,pass);

await setDoc(doc(db,"users",cred.user.uid),{
email:mail,
role:roleVal,
region:regionVal
});

alert("KayÄ±t baÅŸarÄ±lÄ±");
}

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
}

window.logout=async()=>{
await signOut(auth);
}

onAuthStateChanged(auth,async(user)=>{
if(user){
authBox.classList.add("hidden");
app.classList.remove("hidden");
const snap=await getDoc(doc(db,"users",user.uid));
userData=snap.data();

if(userData.role==="isletme"){
showPage("isletmePage");
loadIsletme();
}
if(userData.role==="kurye"){
showPage("kuryePage");
loadKurye();
}
if(userData.role==="admin"){
showPage("adminPage");
loadAdmin();
}
}else{
app.classList.add("hidden");
authBox.classList.remove("hidden");
}
});

window.createOrder=async()=>{
const file=photo.files[0];
if(!file){alert("Foto seÃ§");return;}
const reader=new FileReader();
reader.onload=async()=>{
await addDoc(collection(db,"orders"),{
note:note.value,
region:userData.region,
photo:reader.result,
status:"bekliyor",
createdBy:auth.currentUser.uid,
createdAt:Date.now()
});
alert("SipariÅŸ kaydedildi");
loadIsletme();
}
reader.readAsDataURL(file);
}

async function loadIsletme(){
const q=query(collection(db,"orders"),where("createdBy","==",auth.currentUser.uid));
const snap=await getDocs(q);
isletmeOrders.innerHTML="";
snap.forEach(d=>{
const data=d.data();
isletmeOrders.innerHTML+=`
<div class="card">
<b>${data.note}</b><br>
Durum: ${data.status}<br>
<button onclick="showFis('${d.id}')">FiÅŸi GÃ¶r</button>
</div>`;
});
}

async function loadKurye(){
const q=query(collection(db,"orders"),where("region","==",userData.region));
const snap=await getDocs(q);
kuryeOrders.innerHTML="";
kuryeCount.innerText=snap.size;
snap.forEach(d=>{
const data=d.data();
kuryeOrders.innerHTML+=`
<div class="card">
<b>${data.note}</b><br>
Durum: ${data.status}<br>
<button onclick="showFis('${d.id}')">FiÅŸi GÃ¶r</button>
<button onclick="teslim('${d.id}')">Teslim Edildi</button>
</div>`;
});
}

window.teslim=async(id)=>{
await updateDoc(doc(db,"orders",id),{status:"teslim edildi"});
loadKurye();
}

async function loadAdmin(){
const snap=await getDocs(collection(db,"orders"));
adminOrders.innerHTML="";
snap.forEach(d=>{
const data=d.data();
adminOrders.innerHTML+=`
<div class="card">
${data.note} - ${data.status}
<button onclick="showFis('${d.id}')">FiÅŸi GÃ¶r</button>
</div>`;
});
}

window.showFis=async(id)=>{
const snap=await getDoc(doc(db,"orders",id));
const data=snap.data();
fisContent.innerHTML=`
<div class="card">
<b>${data.note}</b><br>
Durum: ${data.status}<br>
<img src="${data.photo}">
<br><a href="${data.photo}" download="fis.jpg">ğŸ“¥ Ä°ndir</a>
</div>`;
showPage("fisPage");
}

window.showPage=(id)=>{
isletmePage.classList.add("hidden");
kuryePage.classList.add("hidden");
adminPage.classList.add("hidden");
fisPage.classList.add("hidden");
document.getElementById(id).classList.remove("hidden");
}

window.back=()=>{
if(userData.role==="isletme")showPage("isletmePage");
if(userData.role==="kurye")showPage("kuryePage");
if(userData.role==="admin")showPage("adminPage");
}

</script>

</body>
</html>
