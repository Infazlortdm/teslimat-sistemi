<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kurye YÃ¶netim Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
header{background:#111827;padding:15px;text-align:center;font-size:20px}
.container{padding:15px;margin-bottom:90px}
input,select{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:none}
button{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:none;font-weight:bold}
.primary{background:#22c55e;color:white}
.secondary{background:#334155;color:white}
.card{background:#1e293b;padding:10px;margin:8px 0;border-radius:10px}
.hidden{display:none}
.menu{position:fixed;bottom:0;width:100%;display:flex;background:#111827}
.menu button{flex:1;background:#334155;color:white}
.badge{background:red;padding:3px 8px;border-radius:10px;font-size:12px}
.onlineBtn{background:#16a34a}
.offlineBtn{background:#7f1d1d}
img{max-width:100%;border-radius:8px;margin-top:5px}
</style>
</head>
<body>

<header id="mainHeader">Kurye YÃ¶netim Sistemi</header>

<div class="container" id="loginBox">
<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Åžifre">
<button class="primary" onclick="login()">GiriÅŸ Yap</button>
</div>

<div class="container hidden" id="app">

<h3 id="welcome"></h3>

<div id="dashboard"></div>

<div id="content"></div>

<div id="adminPanel" class="hidden">
<h3>KullanÄ±cÄ± OluÅŸtur</h3>
<input id="newEmail" placeholder="Email">
<input id="newPassword" placeholder="Åžifre">
<select id="newRole">
<option value="kurye">Kurye</option>
<option value="isletme">Ä°ÅŸletme</option>
</select>
<input id="newName" placeholder="Ad Soyad">
<input id="newRegion" placeholder="BÃ¶lge">
<input id="newBusiness" placeholder="Ä°ÅŸletme AdÄ± (Kurye boÅŸ)">
<button onclick="addNewUser()" class="primary">OluÅŸtur</button>
</div>

<div class="menu">
<button onclick="showTab('aktif')">Aktif</button>
<button onclick="showTab('gecmis')">GeÃ§miÅŸ</button>
<button onclick="toggleOnline()">Online</button>
<button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, where, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjNRgjDF2r6xrtZw9OwOZS6JHsSQt1bvg",
  authDomain: "teslimat-sistemi.firebaseapp.com",
  projectId: "teslimat-sistemi"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData=null;
let currentTab="aktif";

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
}

window.logout=async()=>{
await signOut(auth);
mainHeader.innerText="Kurye YÃ¶netim Sistemi";
}

onAuthStateChanged(auth,async(user)=>{
if(user){

loginBox.classList.add("hidden");
app.classList.remove("hidden");

const ref=doc(db,"users",user.uid);
const snap=await getDoc(ref);

if(!snap.exists()){
alert("Firestore'da kullanÄ±cÄ± profili yok!");
return;
}

userData=snap.data();

welcome.innerText="HoÅŸgeldin "+userData.name+" ("+userData.region+")";

if(userData.role==="kurye"){
mainHeader.innerText="ðŸšš Kurye Paneli";
loadKurye();
}

if(userData.role==="isletme"){
mainHeader.innerText="ðŸª Ä°ÅŸletme Paneli";
loadIsletme();
}

if(userData.role==="admin"){
mainHeader.innerText="âš™ï¸ Admin Paneli";
adminPanel.classList.remove("hidden");
loadAdmin();
}

}else{
app.classList.add("hidden");
loginBox.classList.remove("hidden");
}
});

async function generateOrderNo(region){
const today=new Date().toISOString().split("T")[0];
const counterRef=doc(db,"counters",today);

return await runTransaction(db,async(transaction)=>{
const counterDoc=await transaction.get(counterRef);
let count=1;

if(counterDoc.exists()){
const data=counterDoc.data();
count=(data[region]||0)+1;
transaction.update(counterRef,{[region]:count});
}else{
transaction.set(counterRef,{[region]:1});
}

return region.substring(0,3).toUpperCase()+"-"+String(count).padStart(4,"0");
});
}

function loadKurye(){
const q=query(collection(db,"orders"),where("region","==",userData.region));
onSnapshot(q,(snap)=>{
content.innerHTML="";
snap.forEach(docSnap=>{
const data=docSnap.data();

if(currentTab==="aktif" && data.status!=="teslim"){
renderOrder(docSnap.id,data);
}
if(currentTab==="gecmis" && data.status==="teslim"){
renderOrder(docSnap.id,data);
}
});
});
}

function renderOrder(id,data){
content.innerHTML+=`
<div class="card">
<b>${data.orderNo}</b><br>
Durum: ${data.status}<br>
<img src="${data.photo}">
${data.status==="bekliyor"?
`<button onclick="takeOrder('${id}')">Paketi Al</button>`:""}
${data.status==="alindi" && data.takenBy===auth.currentUser.uid?
`<button onclick="deliver('${id}')">Teslim Et</button>`:""}
</div>`;
}

window.takeOrder=async(id)=>{
const ref=doc(db,"orders",id);
await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(ref);
if(snap.data().status==="bekliyor"){
transaction.update(ref,{
status:"alindi",
takenBy:auth.currentUser.uid
});
}
});
}

window.deliver=async(id)=>{
await updateDoc(doc(db,"orders",id),{
status:"teslim",
deliveredAt:Date.now()
});
}

window.showTab=(tab)=>{
currentTab=tab;
content.innerHTML="";
if(userData.role==="kurye") loadKurye();
}

window.toggleOnline=async()=>{
await updateDoc(doc(db,"users",auth.currentUser.uid),{
online: !userData.online
});
userData.online=!userData.online;
alert(userData.online?"Online":"Offline");
}

async function createUserByAdmin(email,password,role,name,region,business){
const response = await fetch(
"https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyBjNRgjDF2r6xrtZw9OwOZS6JHsSQt1bvg",
{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({email,password,returnSecureToken:true})
});
const data=await response.json();
const uid=data.localId;

await setDoc(doc(db,"users",uid),{
role,
name,
region:region.toLowerCase(),
business:business||"",
online:false
});
alert("KullanÄ±cÄ± oluÅŸturuldu");
}

window.addNewUser=async()=>{
await createUserByAdmin(
newEmail.value,
newPassword.value,
newRole.value,
newName.value,
newRegion.value,
newBusiness.value
);
}

</script>
</body>
</html>
