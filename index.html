<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teslimat Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; margin:0; background:#0f172a; color:white; }
input, select, button { padding:10px; margin:5px 0; width:100%; border-radius:8px; border:none; }
button { background:#22c55e; color:white; font-weight:bold; }
.hidden { display:none; }
.card { background:#1e293b; padding:15px; margin:10px 0; border-radius:10px; }
.menu { display:flex; justify-content:space-around; background:#111827; padding:10px; position:fixed; bottom:0; width:100%; }
.menu button { width:auto; background:#334155; }
.badge { background:red; padding:3px 8px; border-radius:10px; font-size:12px; }
img { max-width:100%; border-radius:10px; margin-top:10px; }
</style>
</head>

<body>

<h2 id="title">GiriÅŸ Yap</h2>

<div id="authBox">
<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Åifre">

<select id="role">
<option value="isletme">Ä°ÅŸletme</option>
<option value="kurye">Kurye</option>
<option value="admin">Admin</option>
</select>

<input id="region" placeholder="BÃ¶lge (Balkan vs)">
<button onclick="register()">KayÄ±t Ol</button>
<button onclick="login()">GiriÅŸ Yap</button>
</div>

<div id="app" class="hidden">

<div id="isletmePanel" class="hidden">
<h3>Yeni SipariÅŸ</h3>
<input id="note" placeholder="SipariÅŸ Notu">
<input type="file" accept="image/*" capture="camera" id="photo">
<button onclick="createOrder()">SipariÅŸ OluÅŸtur</button>
<div id="isletmeOrders"></div>
</div>

<div id="kuryePanel" class="hidden">
<h3>Atanan Paketler <span id="kuryeCount" class="badge"></span></h3>
<div id="kuryeOrders"></div>
</div>

<div id="adminPanel" class="hidden">
<h3>TÃ¼m SipariÅŸler</h3>
<div id="adminOrders"></div>
</div>

<div class="menu">
<button onclick="showPage('isletmePanel')">ğŸª</button>
<button onclick="showPage('kuryePanel')">ğŸšš</button>
<button onclick="showPage('adminPanel')">âš™</button>
<button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "BURAYA_API_KEY",
  authDomain: "BURAYA_AUTH_DOMAIN",
  projectId: "BURAYA_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserData = null;

window.register = async function() {
  const email = email.value;
  const pass = password.value;
  const roleVal = role.value;
  const regionVal = region.value;

  const userCred = await createUserWithEmailAndPassword(auth,email,pass);

  await setDoc(doc(db,"users",userCred.user.uid),{
    email,
    role: roleVal,
    region: regionVal
  });

  alert("KayÄ±t baÅŸarÄ±lÄ±");
}

window.login = async function() {
  await signInWithEmailAndPassword(auth,email.value,password.value);
}

window.logout = async function() {
  await signOut(auth);
}

onAuthStateChanged(auth, async (user)=>{
  if(user){
    const snap = await getDoc(doc(db,"users",user.uid));
    currentUserData = snap.data();

    authBox.classList.add("hidden");
    app.classList.remove("hidden");

    if(currentUserData.role==="isletme"){
      isletmePanel.classList.remove("hidden");
      loadIsletmeOrders();
    }
    if(currentUserData.role==="kurye"){
      kuryePanel.classList.remove("hidden");
      loadKuryeOrders();
    }
    if(currentUserData.role==="admin"){
      adminPanel.classList.remove("hidden");
      loadAdminOrders();
    }

  }else{
    app.classList.add("hidden");
    authBox.classList.remove("hidden");
  }
});

window.createOrder = async function(){
  const file = photo.files[0];
  const reader = new FileReader();
  reader.onload = async function(){
    const base64 = reader.result;

    await addDoc(collection(db,"orders"),{
      note: note.value,
      region: currentUserData.region,
      photo: base64,
      status:"bekliyor",
      createdBy: auth.currentUser.uid
    });

    alert("SipariÅŸ oluÅŸturuldu");
  }
  reader.readAsDataURL(file);
}

async function loadIsletmeOrders(){
  const q = query(collection(db,"orders"), where("createdBy","==",auth.currentUser.uid));
  const snap = await getDocs(q);
  isletmeOrders.innerHTML="";
  snap.forEach(docu=>{
    const d = docu.data();
    isletmeOrders.innerHTML+=`
      <div class="card">
      ${d.note} - ${d.status}
      <img src="${d.photo}">
      <a href="${d.photo}" download="fis.jpg">Ä°ndir</a>
      </div>`;
  });
}

async function loadKuryeOrders(){
  const q = query(collection(db,"orders"), where("region","==",currentUserData.region));
  const snap = await getDocs(q);
  kuryeOrders.innerHTML="";
  kuryeCount.innerText=snap.size;
  snap.forEach(docu=>{
    const d = docu.data();
    kuryeOrders.innerHTML+=`
      <div class="card">
      ${d.note} - ${d.status}
      <img src="${d.photo}">
      <button onclick="teslim('${docu.id}')">Teslim Edildi</button>
      </div>`;
  });
}

window.teslim = async function(id){
  await updateDoc(doc(db,"orders",id),{
    status:"teslim edildi"
  });
  alert("Teslim edildi");
  loadKuryeOrders();
}

async function loadAdminOrders(){
  const snap = await getDocs(collection(db,"orders"));
  adminOrders.innerHTML="";
  snap.forEach(docu=>{
    const d = docu.data();
    adminOrders.innerHTML+=`
      <div class="card">
      ${d.note} - ${d.status}
      <img src="${d.photo}">
      </div>`;
  });
}

window.showPage = function(id){
  isletmePanel.classList.add("hidden");
  kuryePanel.classList.add("hidden");
  adminPanel.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

</script>

</body>
</html>
