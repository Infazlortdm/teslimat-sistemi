<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teslimat Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
header{background:#111827;padding:15px;text-align:center;font-size:20px}
.container{padding:20px}
input,select{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none}
button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;font-weight:bold}
.primary{background:#22c55e;color:white}
.secondary{background:#334155;color:white}
.card{background:#1e293b;padding:15px;margin:10px 0;border-radius:10px}
.hidden{display:none}
.error{background:#7f1d1d;padding:10px;border-radius:8px;margin-top:5px}
</style>
</head>
<body>

<header>Teslimat Sistemi</header>

<div class="container" id="home">
<button class="primary" onclick="showRegister()">Kayıt Ol</button>
<button class="secondary" onclick="showLogin()">Giriş Yap</button>
</div>

<div class="container hidden" id="registerBox">
<h3>Kayıt Türü</h3>
<select id="role">
<option value="isletme">İşletme</option>
<option value="kurye">Kurye</option>
</select>

<input id="name" placeholder="Ad Soyad">
<input id="business" placeholder="İşletme Adı (kurye boş bırakabilir)">
<input id="region" placeholder="Bölge">
<input id="phone" placeholder="Telefon">
<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Şifre">

<button class="primary" onclick="register()">Kaydı Tamamla</button>
<button class="secondary" onclick="goHome()">Geri</button>
<div id="regError"></div>
</div>

<div class="container hidden" id="loginBox">
<h3>Giriş Yap</h3>
<input id="loginEmail" placeholder="E-posta">
<input id="loginPassword" type="password" placeholder="Şifre">
<button class="primary" onclick="login()">Giriş</button>
<button class="secondary" onclick="goHome()">Geri</button>
<div id="loginError"></div>
</div>

<div class="container hidden" id="app">
<h3>Profil</h3>
<div id="profile"></div>

<div id="isletmePanel" class="hidden">
<h4>Yeni Sipariş</h4>
<input id="note" placeholder="Sipariş Notu">
<input type="file" id="photo" accept="image/*">
<button onclick="createOrder()" class="primary">Sipariş Oluştur</button>
<div id="isletmeOrders"></div>
</div>

<div id="kuryePanel" class="hidden">
<h4>Bölge Siparişleri</h4>
<div id="kuryeOrders"></div>
</div>

<button onclick="logout()" class="secondary">Çıkış</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjNRgjDF2r6xrtZw9OwOZS6JHsSQt1bvg",
  authDomain: "teslimat-sistemi.firebaseapp.com",
  projectId: "teslimat-sistemi"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData=null;

window.showRegister=()=>{home.classList.add("hidden");registerBox.classList.remove("hidden")}
window.showLogin=()=>{home.classList.add("hidden");loginBox.classList.remove("hidden")}
window.goHome=()=>{
registerBox.classList.add("hidden");
loginBox.classList.add("hidden");
home.classList.remove("hidden");
}

window.register=async()=>{
regError.innerHTML="";
try{
const r=role.value;
const n=name.value.trim();
const b=business.value.trim();
const reg=region.value.trim().toLowerCase();
const p=phone.value.trim();
const e=email.value.trim();
const pass=password.value.trim();

if(!n || !reg || !e || !pass){
regError.innerHTML="<div class='error'>Zorunlu alanları doldurun</div>";
return;
}

const cred=await createUserWithEmailAndPassword(auth,e,pass);

await setDoc(doc(db,"users",cred.user.uid),{
role:r,
name:n,
business:b,
region:reg,
phone:p,
email:e
});

alert("Kayıt başarılı");
goHome();

}catch(err){
regError.innerHTML="<div class='error'>Email kullanımda olabilir</div>";
}
}

window.login=async()=>{
loginError.innerHTML="";
try{
await signInWithEmailAndPassword(auth,loginEmail.value.trim(),loginPassword.value.trim());
}catch{
loginError.innerHTML="<div class='error'>Giriş bilgileri yanlış</div>";
}
}

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,async(user)=>{
if(user){
home.classList.add("hidden");
loginBox.classList.add("hidden");
registerBox.classList.add("hidden");
app.classList.remove("hidden");

const snap=await getDoc(doc(db,"users",user.uid));
userData=snap.data();

profile.innerHTML=`
<b>Ad:</b> ${userData.name}<br>
<b>Bölge:</b> ${userData.region}<br>
<b>Rol:</b> ${userData.role}<br>
<b>İşletme:</b> ${userData.business || "-"}
`;

if(userData.role==="isletme"){
isletmePanel.classList.remove("hidden");
loadIsletme();
}
if(userData.role==="kurye"){
kuryePanel.classList.remove("hidden");
loadKurye();
}
}else{
app.classList.add("hidden");
home.classList.remove("hidden");
}
});

window.createOrder=async()=>{
const file=photo.files[0];
if(!file) return alert("Foto seç");

const reader=new FileReader();
reader.onload=async()=>{
await addDoc(collection(db,"orders"),{
note:note.value,
region:userData.region,
business:userData.business,
photo:reader.result,
createdBy:auth.currentUser.uid,
status:"bekliyor"
});
loadIsletme();
}
reader.readAsDataURL(file);
}

async function loadIsletme(){
const q=query(collection(db,"orders"),where("createdBy","==",auth.currentUser.uid));
const snap=await getDocs(q);
isletmeOrders.innerHTML="";
snap.forEach(d=>{
isletmeOrders.innerHTML+=`<div class="card">${d.data().note}</div>`;
});
}

async function loadKurye(){
const q=query(collection(db,"orders"),where("region","==",userData.region));
const snap=await getDocs(q);
kuryeOrders.innerHTML="";
snap.forEach(d=>{
const data=d.data();
kuryeOrders.innerHTML+=`
<div class="card">
${data.note}<br>
İşletme: ${data.business}
</div>`;
});
}

</script>
</body>
</html>
