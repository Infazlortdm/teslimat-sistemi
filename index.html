<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teslimat Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
header{background:#111827;padding:15px;text-align:center;font-size:20px}
.container{padding:20px;margin-bottom:80px}
input,select{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:none}
button{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:none;font-weight:bold}
.primary{background:#22c55e;color:white}
.secondary{background:#334155;color:white}
.card{background:#1e293b;padding:15px;margin:10px 0;border-radius:10px}
.hidden{display:none}
.menu{position:fixed;bottom:0;width:100%;display:flex;background:#111827}
.menu button{flex:1;background:#334155;color:white}
img{max-width:100%;border-radius:10px;margin-top:10px}
.badge{background:red;padding:3px 8px;border-radius:10px;font-size:12px}
.error{background:#7f1d1d;padding:10px;border-radius:8px;margin-top:5px}
</style>
</head>

<body>

<header>Teslimat Sistemi</header>

<div class="container" id="authBox">

<h3>Kayıt / Giriş</h3>

<input id="name" placeholder="Ad Soyad">
<input id="businessName" placeholder="İşletme Adı (Kurye boş bırakabilir)">
<input id="region" placeholder="Bölge (Örnek: Balkan)">
<select id="role">
<option value="isletme">İşletme</option>
<option value="kurye">Kurye</option>
</select>

<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Şifre">

<button class="primary" onclick="register()">Kayıt Ol</button>
<button class="secondary" onclick="login()">Giriş Yap</button>

<div id="errorBox"></div>

</div>

<div class="container hidden" id="app">

<h3 id="welcome"></h3>

<div id="isletmePanel" class="hidden">
<h4>Yeni Sipariş</h4>
<input id="note" placeholder="Sipariş Notu">
<input type="file" id="photo" accept="image/*" capture="environment">
<button class="primary" onclick="createOrder()">Sipariş Oluştur</button>
<h4>Siparişlerim</h4>
<div id="isletmeOrders"></div>
</div>

<div id="kuryePanel" class="hidden">
<h4>Paketlerim <span id="kuryeCount" class="badge"></span></h4>
<div id="kuryeOrders"></div>
</div>

<button onclick="logout()" class="secondary">Çıkış Yap</button>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjNRgjDF2r6xrtZw9OwOZS6JHsSQt1bvg",
  authDomain: "teslimat-sistemi.firebaseapp.com",
  projectId: "teslimat-sistemi"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData=null;

function showError(msg){
errorBox.innerHTML = `<div class="error">${msg}</div>`;
}

window.register=async()=>{
if(!name.value || !region.value || !email.value || !password.value){
showError("Tüm alanları doldurun");
return;
}
try{
const cred=await createUserWithEmailAndPassword(auth,email.value,password.value);

await setDoc(doc(db,"users",cred.user.uid),{
name:name.value,
businessName:businessName.value,
region:region.value.toLowerCase(),
role:role.value,
email:email.value
});

alert("Kayıt başarılı, giriş yapabilirsiniz.");
}catch(e){
if(e.code==="auth/email-already-in-use"){
showError("Bu e-posta zaten kayıtlı. Giriş yapın.");
}else{
showError(e.message);
}
}
}

window.login=async()=>{
try{
await signInWithEmailAndPassword(auth,email.value,password.value);
}catch(e){
showError("E-posta veya şifre yanlış");
}
}

window.logout=async()=>{await signOut(auth);}

onAuthStateChanged(auth,async(user)=>{
if(user){
authBox.classList.add("hidden");
app.classList.remove("hidden");

const snap=await getDoc(doc(db,"users",user.uid));
userData=snap.data();

welcome.innerText="Hoşgeldin " + userData.name;

if(userData.role==="isletme"){
isletmePanel.classList.remove("hidden");
loadIsletme();
}
if(userData.role==="kurye"){
kuryePanel.classList.remove("hidden");
loadKurye();
}
}else{
app.classList.add("hidden");
authBox.classList.remove("hidden");
}
});

window.createOrder=async()=>{
const file=photo.files[0];
if(!file){alert("Fotoğraf seçin");return;}

const reader=new FileReader();
reader.onload=async()=>{
await addDoc(collection(db,"orders"),{
note:note.value,
region:userData.region,
photo:reader.result,
status:"bekliyor",
createdBy:auth.currentUser.uid,
business:userData.businessName,
createdAt:Date.now()
});
alert("Sipariş oluşturuldu");
loadIsletme();
}
reader.readAsDataURL(file);
}

async function loadIsletme(){
const q=query(collection(db,"orders"),where("createdBy","==",auth.currentUser.uid));
const snap=await getDocs(q);
isletmeOrders.innerHTML="";
snap.forEach(d=>{
const data=d.data();
isletmeOrders.innerHTML+=`
<div class="card">
<b>${data.note}</b><br>
Durum: ${data.status}
</div>`;
});
}

async function loadKurye(){
const q=query(collection(db,"orders"),where("region","==",userData.region));
const snap=await getDocs(q);
kuryeOrders.innerHTML="";
kuryeCount.innerText=snap.size;
snap.forEach(d=>{
const data=d.data();
kuryeOrders.innerHTML+=`
<div class="card">
<b>${data.note}</b><br>
İşletme: ${data.business}<br>
Durum: ${data.status}<br>
<img src="${data.photo}">
<button onclick="teslim('${d.id}')">Teslim Edildi</button>
</div>`;
});
}

window.teslim=async(id)=>{
await updateDoc(doc(db,"orders",id),{status:"teslim edildi"});
loadKurye();
}

</script>
</body>
</html>
