<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teslimat Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
header{background:#111827;padding:15px;text-align:center;font-size:20px}
.container{padding:20px;margin-bottom:80px}
input,select{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:none}
button{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:none;font-weight:bold}
.primary{background:#22c55e;color:white}
.secondary{background:#334155;color:white}
.card{background:#1e293b;padding:15px;margin:10px 0;border-radius:10px}
.hidden{display:none}
.roleBox{display:flex;gap:10px}
.roleBox button{flex:1;font-size:18px}
.error{background:#7f1d1d;padding:10px;border-radius:8px;margin-top:5px}
img{max-width:100%;border-radius:8px;margin-top:10px}
</style>
</head>
<body>

<header>Teslimat Sistemi</header>

<div class="container" id="roleSelect">
<h3>Devam etmek iÃ§in seÃ§in</h3>
<div class="roleBox">
<button class="primary" onclick="chooseRole('isletme')">ğŸª Ä°ÅŸletme</button>
<button class="secondary" onclick="chooseRole('kurye')">ğŸšš Kurye</button>
</div>
</div>

<div class="container hidden" id="authBox">

<h3 id="formTitle"></h3>

<input id="name" placeholder="Ad Soyad">
<input id="businessName" placeholder="Ä°ÅŸletme AdÄ± (Kurye boÅŸ bÄ±rakabilir)">
<input id="region" placeholder="BÃ¶lge (Ã–rnek: Balkan)">
<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Åifre">

<button class="primary" onclick="register()">KayÄ±t Ol</button>
<button class="secondary" onclick="login()">GiriÅŸ Yap</button>

<div id="errorBox"></div>

</div>

<div class="container hidden" id="app">

<h3 id="welcome"></h3>

<div id="isletmePanel" class="hidden">
<h4>Yeni SipariÅŸ</h4>
<input id="note" placeholder="SipariÅŸ Notu">
<input type="file" id="photo" accept="image/*" capture="environment">
<button class="primary" onclick="createOrder()">SipariÅŸ OluÅŸtur</button>
<h4>SipariÅŸlerim</h4>
<div id="isletmeOrders"></div>
</div>

<div id="kuryePanel" class="hidden">
<h4>Paketler</h4>
<div id="kuryeOrders"></div>
</div>

<button class="secondary" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjNRgjDF2r6xrtZw9OwOZS6JHsSQt1bvg",
  authDomain: "teslimat-sistemi.firebaseapp.com",
  projectId: "teslimat-sistemi"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let selectedRole=null;
let userData=null;

window.chooseRole=(role)=>{
selectedRole=role;
roleSelect.classList.add("hidden");
authBox.classList.remove("hidden");
formTitle.innerText = role==="isletme" ? "Ä°ÅŸletme HesabÄ±" : "Kurye HesabÄ±";
}

function showError(msg){
errorBox.innerHTML = `<div class="error">${msg}</div>`;
}

window.register=async()=>{
const n=name.value.trim();
const b=businessName.value.trim();
const r=region.value.trim().toLowerCase();
const e=email.value.trim();
const p=password.value.trim();

if(!n || !r || !e || !p){
showError("TÃ¼m zorunlu alanlarÄ± doldurun.");
return;
}

try{
const cred=await createUserWithEmailAndPassword(auth,e,p);

await setDoc(doc(db,"users",cred.user.uid),{
name:n,
businessName:b,
region:r,
role:selectedRole,
email:e
});

alert("KayÄ±t baÅŸarÄ±lÄ±");
}catch(err){
showError("Bu e-posta zaten kayÄ±tlÄ± veya hata var.");
}
}

window.login=async()=>{
try{
await signInWithEmailAndPassword(auth,email.value.trim(),password.value.trim());
}catch(err){
showError("E-posta veya ÅŸifre yanlÄ±ÅŸ.");
}
}

window.logout=async()=>{await signOut(auth);}

onAuthStateChanged(auth,async(user)=>{
if(user){
authBox.classList.add("hidden");
app.classList.remove("hidden");

const snap=await getDoc(doc(db,"users",user.uid));
userData=snap.data();

welcome.innerText="HoÅŸgeldin "+userData.name+" ("+userData.region+")";

if(userData.role==="isletme"){
isletmePanel.classList.remove("hidden");
loadIsletme();
}
if(userData.role==="kurye"){
kuryePanel.classList.remove("hidden");
loadKurye();
}
}else{
app.classList.add("hidden");
roleSelect.classList.remove("hidden");
}
});

window.createOrder=async()=>{
const file=photo.files[0];
if(!file){alert("FotoÄŸraf seÃ§in");return;}

const reader=new FileReader();
reader.onload=async()=>{
await addDoc(collection(db,"orders"),{
note:note.value.trim(),
region:userData.region,
photo:reader.result,
status:"bekliyor",
business:userData.businessName,
createdBy:auth.currentUser.uid,
createdAt:Date.now()
});
alert("SipariÅŸ oluÅŸturuldu");
loadIsletme();
}
reader.readAsDataURL(file);
}

async function loadIsletme(){
const q=query(collection(db,"orders"),where("createdBy","==",auth.currentUser.uid));
const snap=await getDocs(q);
isletmeOrders.innerHTML="";
snap.forEach(d=>{
const data=d.data();
isletmeOrders.innerHTML+=`
<div class="card">
<b>${data.note}</b><br>
Durum: ${data.status}
</div>`;
});
}

async function loadKurye(){
const q=query(collection(db,"orders"),where("region","==",userData.region));
const snap=await getDocs(q);
kuryeOrders.innerHTML="";
snap.forEach(d=>{
const data=d.data();
kuryeOrders.innerHTML+=`
<div class="card">
<b>${data.note}</b><br>
Ä°ÅŸletme: ${data.business}<br>
Durum: ${data.status}<br>
<img src="${data.photo}">
<button onclick="teslim('${d.id}')">Teslim Edildi</button>
</div>`;
});
}

window.teslim=async(id)=>{
await updateDoc(doc(db,"orders",id),{status:"teslim edildi"});
loadKurye();
}

</script>
</body>
</html>
