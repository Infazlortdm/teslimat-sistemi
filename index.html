<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kurye Yönetim Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
header{background:#111827;padding:15px;text-align:center;font-size:20px}
.container{padding:15px;margin-bottom:80px}
input,select{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:none}
button{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:none;font-weight:bold}
.primary{background:#22c55e;color:white}
.secondary{background:#334155;color:white}
.card{background:#1e293b;padding:10px;margin:8px 0;border-radius:10px}
.hidden{display:none}
.menu{position:fixed;bottom:0;width:100%;display:flex;background:#111827}
.menu button{flex:1;background:#334155;color:white}
.badge{background:red;padding:3px 8px;border-radius:10px;font-size:12px}
.online{background:#16a34a}
.offline{background:#7f1d1d}
img{max-width:100%;border-radius:8px;margin-top:5px}
</style>
</head>
<body>

<header>Kurye Sistemi</header>

<div class="container" id="loginBox">
<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Şifre">
<button class="primary" onclick="login()">Giriş Yap</button>
</div>

<div class="container hidden" id="app">

<h3 id="welcome"></h3>

<div id="dashboard"></div>

<div id="content"></div>

<div class="menu">
<button onclick="showTab('aktif')">Aktif</button>
<button onclick="showTab('gecmis')">Geçmiş</button>
<button onclick="toggleOnline()">Online</button>
<button onclick="logout()">Çıkış</button>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs, query, where, onSnapshot, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjNRgjDF2r6xrtZw9OwOZS6JHsSQt1bvg",
  authDomain: "teslimat-sistemi.firebaseapp.com",
  projectId: "teslimat-sistemi"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData=null;
let currentTab="aktif";

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
}

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,async(user)=>{
if(user){
loginBox.classList.add("hidden");
app.classList.remove("hidden");

const ref=doc(db,"users",user.uid);
const snap=await getDoc(ref);

if(!snap.exists()){
alert("Kullanıcı profili yok.");
return;
}

userData=snap.data();
welcome.innerText="Hoşgeldin "+userData.name+" ("+userData.region+")";

initRealtime();

}else{
app.classList.add("hidden");
loginBox.classList.remove("hidden");
}
});

function initRealtime(){

if(userData.role==="kurye"){
loadKurye();
}

if(userData.role==="isletme"){
loadIsletme();
}

if(userData.role==="admin"){
loadAdmin();
}

}

async function generateOrderNo(region){

const today=new Date().toISOString().split("T")[0];
const counterRef=doc(db,"counters",today);

return await runTransaction(db,async(transaction)=>{

const counterDoc=await transaction.get(counterRef);

let count=1;

if(counterDoc.exists()){
const data=counterDoc.data();
count=(data[region]||0)+1;
transaction.update(counterRef,{[region]:count});
}else{
transaction.set(counterRef,{[region]:1});
}

return region.substring(0,3).toUpperCase()+"-"+String(count).padStart(4,"0");

});
}

window.createOrder=async()=>{
const file=photo.files[0];
if(!file) return alert("Foto seç");

const reader=new FileReader();
reader.onload=async()=>{
const orderNo=await generateOrderNo(userData.region);

await addDoc(collection(db,"orders"),{
orderNo,
region:userData.region,
status:"bekliyor",
takenBy:null,
business:userData.business,
photo:reader.result,
createdAt:Date.now()
});

};
reader.readAsDataURL(file);
}

function loadKurye(){

const q=query(collection(db,"orders"),
where("region","==",userData.region));

onSnapshot(q,(snap)=>{

content.innerHTML="";
snap.forEach(docSnap=>{

const data=docSnap.data();

if(currentTab==="aktif" && data.status!=="teslim"){
renderOrder(docSnap.id,data);
}

if(currentTab==="gecmis" && data.status==="teslim"){
renderOrder(docSnap.id,data);
}

});

});
}

function renderOrder(id,data){

content.innerHTML+=`
<div class="card">
<b>${data.orderNo}</b><br>
Durum: ${data.status}<br>
<img src="${data.photo}">
${data.status==="bekliyor" ?
`<button onclick="takeOrder('${id}')">Paketi Al</button>`:""}
${data.status==="alindi" && data.takenBy===auth.currentUser.uid ?
`<button onclick="deliver('${id}')">Teslim Et</button>`:""}
</div>
`;
}

window.takeOrder=async(id)=>{

const ref=doc(db,"orders",id);

await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(ref);
if(snap.data().status==="bekliyor"){
transaction.update(ref,{
status:"alindi",
takenBy:auth.currentUser.uid
});
}
});

}

window.deliver=async(id)=>{
await updateDoc(doc(db,"orders",id),{
status:"teslim",
deliveredAt:Date.now()
});
}

window.showTab=(tab)=>{
currentTab=tab;
content.innerHTML="";
initRealtime();
}

window.toggleOnline=async()=>{
await updateDoc(doc(db,"users",auth.currentUser.uid),{
online: !userData.online
});
userData.online=!userData.online;
alert(userData.online?"Online":"Offline");
}

</script>
</body>
</html>
